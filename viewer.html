<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Projector</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@1/dist/hls.min.js"></script>
<style>
  * { margin: 0; padding: 0; }
  body {
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    height: 100dvh;
    overflow: hidden;
  }
  video {
    max-width: 100vw;
    max-height: 100vh;
    max-height: 100dvh;
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #000;
  }
  #status {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #666;
    font-family: -apple-system, sans-serif;
    font-size: 1rem;
  }
</style>
</head>
<body>
<video id="video" autoplay muted playsinline></video>
<div id="status">Connecting...</div>
<script>
  const video = document.getElementById("video");
  const status = document.getElementById("status");
  const hlsUrl = "/hls/stream.m3u8";

  function hideStatus() {
    status.style.display = "none";
  }

  function startPlayback() {
    if (Hls.isSupported()) {
      const hls = new Hls({
        liveSyncDurationCount: 1,
        liveMaxLatencyDurationCount: 2,
        lowLatencyMode: true,
        enableWorker: true,
        maxBufferLength: 0.5,
        maxMaxBufferLength: 1,
        backBufferLength: 0,
        liveDurationInfinity: true,
        highBufferWatchdogPeriod: 1,
      });
      hls.loadSource(hlsUrl);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        video.play();
        hideStatus();
      });
      hls.on(Hls.Events.ERROR, (event, data) => {
        if (data.fatal) {
          status.textContent = "Stream ended. Reconnecting...";
          status.style.display = "block";
          setTimeout(() => {
            hls.destroy();
            startPlayback();
          }, 2000);
        }
      });
    } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
      // Safari / iOS native HLS
      video.src = hlsUrl;
      video.addEventListener("loadedmetadata", () => {
        video.play();
        hideStatus();
      });
      video.addEventListener("error", () => {
        status.textContent = "Stream ended. Reconnecting...";
        status.style.display = "block";
        setTimeout(startPlayback, 2000);
      });
    } else {
      status.textContent = "HLS not supported in this browser.";
    }
  }

  // Wait for stream to be ready, then start
  function waitForStream() {
    fetch(hlsUrl)
      .then(r => {
        if (r.ok) {
          startPlayback();
        } else {
          setTimeout(waitForStream, 500);
        }
      })
      .catch(() => setTimeout(waitForStream, 500));
  }

  waitForStream();
</script>
</body>
</html>
